# Store Page 邏輯修正說明

## 問題描述

原本的 store_page.dart 存在以下邏輯錯誤：

1. **全局狀態污染問題**：當一個用戶購買或領取商品後，會直接更新 Firebase 中該商品的狀態為"已擁有"，這會影響所有用戶看到該商品。

2. **用戶識別錯誤**：使用 `username` 而不是 `uid` 來查詢用戶文檔，導致無法正確識別用戶。

3. **狀態判斷錯誤**：在檢查商品是否已擁有時，同時檢查了用戶的 `purchasedItems` 和商品的全局 `狀態` 欄位，造成邏輯混亂。

## 修正內容

### 1. 移除全局狀態更新
- **移除函數**：`_updateItemStatus()` 函數已被註解掉
- **移除調用**：在 `_showConfirmDialog()` 中移除了對 `_updateItemStatus()` 的調用
- **原因**：商品狀態不應該因為個別用戶的購買行為而改變，這會影響所有用戶

### 2. 修正用戶識別邏輯
- **修正前**：使用 `username` 作為文檔 ID
- **修正後**：使用 `uid` 作為文檔 ID
- **影響函數**：
  - `_loadPurchasedItems()`
  - `_getUserPurchasedItemsStream()`
  - `_claimItem()`
  - `_buyItem()`

### 3. 修正商品擁有狀態判斷
- **修正前**：同時檢查用戶的 `purchasedItems` 和商品的全局 `狀態`
- **修正後**：只檢查用戶的 `purchasedItems` 欄位
- **影響位置**：`buildItem()` 函數中的 `StreamBuilder`

### 4. 修正按鈕點擊邏輯
- **修正前**：`onTap: isOwned ? null : ...`
- **修正後**：`onTap: isPurchased ? null : ...`
- **原因**：應該根據用戶是否已購買來決定按鈕是否可點擊

## 修正後的邏輯流程

1. **用戶登入**：讀取用戶的 `purchasedItems` 列表
2. **顯示商品**：根據用戶的 `purchasedItems` 判斷是否顯示"已擁有"
3. **購買/領取**：將商品 ID 添加到用戶的 `purchasedItems` 列表中
4. **狀態更新**：只更新用戶文檔，不影響商品文檔的全局狀態

## 資料結構

### 用戶文檔結構
```json
{
  "uid": "用戶唯一識別碼",
  "username": "用戶名",
  "purchasedItems": ["商品ID1", "商品ID2", ...],
  "purchasedItemsWithCategory": {
    "商品ID1": {
      "name": "商品名稱",
      "category": "商品類別",
      "imageUrl": "圖片URL",
      "purchasedAt": "購買時間"
    }
  }
}
```

### 商品文檔結構
```json
{
  "name": "商品名稱",
  "價格": 100,
  "圖片": "圖片URL",
  "常見度": "常見",
  "狀態": "登入領取" // 這個欄位不再被修改
}
```

## 測試建議

1. **多用戶測試**：確保不同用戶的購買狀態互不影響
2. **購買流程測試**：確保購買後正確更新用戶的 `purchasedItems`
3. **UI 更新測試**：確保購買後 UI 正確顯示"已擁有"狀態
4. **資料一致性測試**：確保用戶文檔和商品文檔的資料一致性

## 注意事項

- 商品的 `狀態` 欄位現在只用於顯示，不再被程式修改
- 每個用戶的購買狀態完全獨立，存儲在各自的用戶文檔中
- 使用 `uid` 確保用戶識別的唯一性和正確性
