# æ­¡è¿é‡‘å¹£å‹•ç•«å„ªåŒ–ç¸½çµ

## å•é¡Œæè¿°
ç”¨æˆ¶è¦æ±‚ï¼šè‹¥é¦–æ¬¡ç™»å…¥ï¼Œæœªé ˜å–é‡‘å¹£ï¼Œæœƒåœ¨ä¸‹ä¸€æ¬¡ç™»å…¥æ™‚å†æ¬¡é¡¯ç¤ºå‹•ç•«ã€‚

## å¯¦ç¾å…§å®¹

### ğŸ¯ **1. å•é¡Œåˆ†æ**

#### åŸæœ‰é‚è¼¯
- **è§¸ç™¼æ¢ä»¶**: åŸºæ–¼ `loginCount == 1`ï¼ˆé¦–æ¬¡ç™»å…¥ï¼‰
- **å•é¡Œ**: å¦‚æœç”¨æˆ¶é¦–æ¬¡ç™»å…¥æ™‚æ²’æœ‰é»æ“Š"ç«‹å³é ˜å–"æŒ‰éˆ•ï¼Œå‹•ç•«å°±ä¸æœƒå†é¡¯ç¤º
- **çµæœ**: ç”¨æˆ¶éŒ¯éé ˜å–æ­¡è¿é‡‘å¹£çš„æ©Ÿæœƒ

#### æ–°é‚è¼¯
- **è§¸ç™¼æ¢ä»¶**: åŸºæ–¼æ˜¯å¦å·²é ˜å–æ­¡è¿é‡‘å¹£
- **è§£æ±ºæ–¹æ¡ˆ**: æ¯æ¬¡ç™»å…¥éƒ½æª¢æŸ¥æ˜¯å¦å·²é ˜å–ï¼Œæœªé ˜å–å‰‡é¡¯ç¤ºå‹•ç•«
- **çµæœ**: ç¢ºä¿ç”¨æˆ¶ä¸æœƒéŒ¯éæ­¡è¿é‡‘å¹£

### ğŸ”§ **2. æ–°å¢æœå‹™**

#### `WelcomeCoinService` æ ¸å¿ƒåŠŸèƒ½
```dart
class WelcomeCoinService {
  // æª¢æŸ¥æ˜¯å¦å·²é ˜å–æ­¡è¿é‡‘å¹£
  static Future<bool> hasClaimedWelcomeCoin()
  
  // æ¨™è¨˜ç‚ºå·²é ˜å–
  static Future<void> markWelcomeCoinAsClaimed()
  
  // é ˜å–æ­¡è¿é‡‘å¹£
  static Future<bool> claimWelcomeCoin()
  
  // é‡ç½®ç‹€æ…‹ï¼ˆæ¸¬è©¦ç”¨ï¼‰
  static Future<void> resetWelcomeCoinStatus()
  
  // ç²å–é‡‘å¹£æ•¸é‡
  static int getWelcomeCoinAmount()
}
```

### ğŸ’¾ **3. æ•¸æ“šå­˜å„²æ©Ÿåˆ¶**

#### Firebase å­—æ®µ
```json
{
  "users": {
    "uid": {
      "welcomeCoinClaimed": true/false,
      "welcomeCoinClaimedDate": Timestamp,
      "lastUpdated": Timestamp
    }
  }
}
```

#### æœ¬åœ°å­˜å„²
```dart
// SharedPreferences éµå€¼
'welcome_coin_claimed_$username': true/false
```

#### é›™é‡ä¿éšœ
- **ä¸»è¦æ•¸æ“šæº**: Firebase ç”¨æˆ¶æ–‡æª”
- **å‚™ç”¨æ•¸æ“šæº**: æœ¬åœ° SharedPreferences
- **åŒæ­¥æ©Ÿåˆ¶**: ç‹€æ…‹è®Šæ›´æ™‚åŒæ™‚æ›´æ–°å…©è™•

### ğŸ”„ **4. æª¢æŸ¥é‚è¼¯**

#### æª¢æŸ¥æµç¨‹
```dart
// 1. å¾ Firebase æª¢æŸ¥
final userDoc = await FirebaseFirestore.instance
    .collection('users')
    .doc(uid)
    .get();

if (userDoc.exists) {
  final hasClaimed = userDoc.data()['welcomeCoinClaimed'] ?? false;
  if (hasClaimed) return true;
}

// 2. å¾æœ¬åœ°å­˜å„²æª¢æŸ¥ï¼ˆå‚™ç”¨ï¼‰
final prefs = await SharedPreferences.getInstance();
final localHasClaimed = prefs.getBool('welcome_coin_claimed_$username') ?? false;
return localHasClaimed;
```

### ğŸ“± **5. å‹•ç•«è§¸ç™¼é‚è¼¯**

#### ä¿®æ”¹å‰
```dart
// åŸºæ–¼ç™»å…¥æ¬¡æ•¸
final loginCount = userData['loginCount'] ?? 0;
if (loginCount == 1) {
  _showWelcomeAnimation = true;
}
```

#### ä¿®æ”¹å¾Œ
```dart
// åŸºæ–¼æ˜¯å¦å·²é ˜å–
final hasClaimedWelcomeCoin = await WelcomeCoinService.hasClaimedWelcomeCoin();
if (!hasClaimedWelcomeCoin) {
  _showWelcomeAnimation = true;
}
```

### ğŸ¯ **6. é‡‘å¹£é ˜å–æµç¨‹**

#### é ˜å–æ­¥é©Ÿ
1. **æª¢æŸ¥ç‹€æ…‹**: ç¢ºèªç”¨æˆ¶å°šæœªé ˜å–
2. **æ›´æ–°é‡‘å¹£**: å¢åŠ ç”¨æˆ¶é‡‘å¹£æ•¸é‡
3. **æ¨™è¨˜ç‹€æ…‹**: è¨­ç½®ç‚ºå·²é ˜å–
4. **åŒæ­¥æ•¸æ“š**: æ›´æ–° Firebase å’Œæœ¬åœ°å­˜å„²
5. **æ›´æ–°UI**: åˆ·æ–°é‡‘å¹£é¡¯ç¤º

#### éŒ¯èª¤è™•ç†
- **é‡è¤‡é ˜å–**: æª¢æŸ¥ä¸¦é˜»æ­¢
- **ç¶²çµ¡ç•°å¸¸**: æœ¬åœ°å­˜å„²å‚™ç”¨
- **æ•¸æ“šä¸ä¸€è‡´**: Firebase å„ªå…ˆ

### ğŸ”’ **7. å®‰å…¨æ©Ÿåˆ¶**

#### é˜²é‡è¤‡é ˜å–
```dart
// æª¢æŸ¥æ˜¯å¦å·²ç¶“é ˜å–é
final hasClaimed = await hasClaimedWelcomeCoin();
if (hasClaimed) {
  LoggerService.warning('ç”¨æˆ¶å·²ç¶“é ˜å–éæ­¡è¿é‡‘å¹£');
  return false;
}
```

#### ç‹€æ…‹é©—è­‰
- **Firebase å„ªå…ˆ**: ä¸»è¦é©—è­‰ä¾†æº
- **æœ¬åœ°å‚™ç”¨**: ç¶²çµ¡ç•°å¸¸æ™‚çš„å‚™ç”¨æ–¹æ¡ˆ
- **è‡ªå‹•åŒæ­¥**: ç‹€æ…‹è®Šæ›´æ™‚è‡ªå‹•åŒæ­¥

### ğŸ¨ **8. ç”¨æˆ¶é«”é©—æ”¹é€²**

#### å‹•ç•«é¡¯ç¤º
- **å‹•æ…‹é‡‘å¹£æ•¸é‡**: ä½¿ç”¨ `WelcomeCoinService.getWelcomeCoinAmount()`
- **çµ±ä¸€ç®¡ç†**: é‡‘å¹£æ•¸é‡é›†ä¸­é…ç½®
- **éˆæ´»èª¿æ•´**: å¯è¼•é¬†ä¿®æ”¹é‡‘å¹£æ•¸é‡

#### ç‹€æ…‹æç¤º
- **æˆåŠŸæç¤º**: "æˆåŠŸç²å¾— 500 é‡‘å¹£ï¼"
- **éŒ¯èª¤è™•ç†**: é ˜å–å¤±æ•—æ™‚çš„éŒ¯èª¤æç¤º
- **ç‹€æ…‹åŒæ­¥**: å¯¦æ™‚æ›´æ–°é‡‘å¹£é¡¯ç¤º

### ğŸ”§ **9. æŠ€è¡“å¯¦ç¾ç´°ç¯€**

#### æœå‹™æ•´åˆ
```dart
// chat_page.dart ä¸­çš„æ•´åˆ
import 'welcome_coin_service.dart';

// æª¢æŸ¥ç‹€æ…‹
final hasClaimedWelcomeCoin = await WelcomeCoinService.hasClaimedWelcomeCoin();

// é ˜å–é‡‘å¹£
final success = await WelcomeCoinService.claimWelcomeCoin();

// ç²å–æ•¸é‡
final coinAmount = WelcomeCoinService.getWelcomeCoinAmount();
```

#### æ•¸æ“šåŒæ­¥
- **å³æ™‚æ›´æ–°**: é ˜å–å¾Œç«‹å³æ›´æ–°ç”¨æˆ¶æ•¸æ“š
- **UI åˆ·æ–°**: è‡ªå‹•åˆ·æ–°é‡‘å¹£é¡¯ç¤ºçµ„ä»¶
- **ç‹€æ…‹æŒä¹…åŒ–**: ç¢ºä¿ç‹€æ…‹åœ¨é‡å•Ÿå¾Œä¿æŒ

### âœ… **10. ç·¨è­¯æª¢æŸ¥**

#### ç·¨è­¯ç‹€æ…‹
- `flutter analyze lib/welcome_coin_service.dart` - **No issues found!**
- `flutter analyze lib/chat_page.dart` - **No issues found!**

### ğŸ§ª **11. æ¸¬è©¦å»ºè­°**

#### åŠŸèƒ½æ¸¬è©¦
1. **é¦–æ¬¡ç™»å…¥**: ç¢ºèªå‹•ç•«æ­£å¸¸é¡¯ç¤º
2. **æœªé ˜å–ç™»å‡º**: ç¢ºèªä¸‹æ¬¡ç™»å…¥å†æ¬¡é¡¯ç¤º
3. **æˆåŠŸé ˜å–**: ç¢ºèªç‹€æ…‹æ­£ç¢ºæ¨™è¨˜
4. **é‡è¤‡ç™»å…¥**: ç¢ºèªä¸å†é¡¯ç¤ºå‹•ç•«
5. **ç¶²çµ¡ç•°å¸¸**: ç¢ºèªæœ¬åœ°å­˜å„²å‚™ç”¨æ©Ÿåˆ¶

#### é‚Šç•Œæ¸¬è©¦
1. **é‡è¤‡é ˜å–**: ç¢ºèªç„¡æ³•é‡è¤‡é ˜å–
2. **æ•¸æ“šé‡ç½®**: ç¢ºèªé‡ç½®åŠŸèƒ½æ­£å¸¸
3. **å¤šè¨­å‚™åŒæ­¥**: ç¢ºèªç‹€æ…‹åœ¨ä¸åŒè¨­å‚™é–“åŒæ­¥

### ğŸ“Š **12. æ•¸æ“šçµæ§‹**

#### Firebase ç”¨æˆ¶æ–‡æª”
```json
{
  "uid": "user123",
  "username": "testuser",
  "coins": 500,
  "welcomeCoinClaimed": true,
  "welcomeCoinClaimedDate": "2024-01-01T00:00:00.000Z",
  "lastUpdated": "2024-01-01T00:00:00.000Z"
}
```

#### æœ¬åœ°å­˜å„²
```dart
// SharedPreferences
'welcome_coin_claimed_testuser': true
```

## ç¸½çµ

æˆåŠŸå¯¦ç¾äº†æ­¡è¿é‡‘å¹£å‹•ç•«çš„å„ªåŒ–ï¼ŒåŒ…æ‹¬ï¼š

### âœ… **æ ¸å¿ƒæ”¹é€²**
- **è§¸ç™¼é‚è¼¯**: å¾åŸºæ–¼ç™»å…¥æ¬¡æ•¸æ”¹ç‚ºåŸºæ–¼é ˜å–ç‹€æ…‹
- **æŒä¹…åŒ–å­˜å„²**: Firebase + æœ¬åœ°å­˜å„²é›™é‡ä¿éšœ
- **é˜²é‡è¤‡æ©Ÿåˆ¶**: ç¢ºä¿ç”¨æˆ¶åªèƒ½é ˜å–ä¸€æ¬¡
- **ç‹€æ…‹åŒæ­¥**: å¯¦æ™‚åŒæ­¥é ˜å–ç‹€æ…‹

### âœ… **ç”¨æˆ¶é«”é©—**
- **ä¸æœƒéŒ¯é**: ç¢ºä¿ç”¨æˆ¶ä¸æœƒéŒ¯éæ­¡è¿é‡‘å¹£
- **éˆæ´»è§¸ç™¼**: ä»»ä½•æœªé ˜å–çš„ç™»å…¥éƒ½æœƒé¡¯ç¤ºå‹•ç•«
- **ç‹€æ…‹æŒä¹…**: é ˜å–ç‹€æ…‹æ°¸ä¹…ä¿å­˜
- **éŒ¯èª¤è™•ç†**: å®Œå–„çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

### âœ… **æŠ€è¡“å„ªå‹¢**
- **æœå‹™åŒ–**: ç¨ç«‹çš„ç®¡ç†æœå‹™
- **å¯ç¶­è­·**: æ¸…æ™°çš„ä»£ç¢¼çµæ§‹
- **å¯æ“´å±•**: æ˜“æ–¼æ·»åŠ æ–°åŠŸèƒ½
- **å¯é æ€§**: é›™é‡æ•¸æ“šä¿éšœ

æ–°æ©Ÿåˆ¶ç¢ºä¿äº†ç”¨æˆ¶ä¸æœƒå› ç‚ºä»»ä½•åŸå› éŒ¯éæ­¡è¿é‡‘å¹£ï¼Œæä¾›äº†æ›´å¥½çš„ç”¨æˆ¶é«”é©—å’Œæ›´å¯é çš„æŠ€è¡“å¯¦ç¾ã€‚
